<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>골프장 예약 시스템</title>
    <!-- Firebase -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        /* 기본 스타일 */
        body {font-family: Arial; margin:0; padding:0;}

        /* 상단바 */
        #top-bar {display:flex; justify-content:space-between; align-items:center; padding:10px; background:#f5f5f5; border-bottom:1px solid #ccc;}
        #top-bar button {padding:8px; border:none; cursor:pointer; border-radius:4px;}
        #admin-button {background:#ff6347; color:white;}
        #login-button {background:#007bff; color:white; margin-left:10px;}
        
        /* 메인 */
        #calendar-container {display:none; padding:20px; overflow:auto;}
        table {border-collapse:collapse; width:100%; max-width:800px; margin:0 auto;}
        th, td {border:1px solid #ccc; padding:10px; text-align:center; cursor:pointer;}
        th {background:#f0f0f0;}
        td.available {background:#d0f5d0;}
        td.reserved {background:#ffe066;}
        td:hover {opacity:0.8;}

        /* 예약 팝업 */
        #booking-popup {display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:20px; border:1px solid #ccc; box-shadow:0 0 10px rgba(0,0,0,0.3); z-index:100;}
        #booking-popup input {width:100%; padding:8px; margin:5px 0;}
        #booking-popup button {width:100%; padding:10px; background:#28a745; color:white; border:none; border-radius:4px; cursor:pointer; margin-top:5px;}

        /* 예약 내역 */
        #user-results {margin-top:20px;}
    </style>
</head>
<body>
    <!-- 상단바 -->
    <div id="top-bar">
        <div>
            <button id="admin-button" onclick="openAdminPanel()">ADM</button>
        </div>
        <div>
            <input type="date" id="selected-date"> 
            <button id="login-button" onclick="googleLogin()">Google 로그인</button>
        </div>
    </div>

    <!-- 메인 캘린더 -->
    <div id="calendar-container">
        <h2>예약 가능 시간표</h2>
        <table id="calendar"></table>
        <div id="user-results"></div>
    </div>

    <!-- 예약 팝업 -->
    <div id="booking-popup">
        <h3>예약 신청</h3>
        <input type="text" id="reserver-name" placeholder="예약자명">
        <input type="text" id="member-id" placeholder="회원번호">
        <input type="number" id="people" placeholder="인원수 (1~4명)" min="1" max="4">
        <input type="text" id="remarks" placeholder="비고">
        <button onclick="bookTime()">예약하기</button>
        <button onclick="closePopup()">닫기</button>
    </div>

    <script>
        // ===== Firebase 설정 =====
        const firebaseConfig = {apiKey: "AIzaSyBXvjwzG6qpgW6W9H6-KBeXeJcqS1ZCdLA", authDomain: "reservation-344b6.firebaseapp.com", projectId: "reservation-344b6", storageBucket: "reservation-344b6.appspot.com", messagingSenderId: "191262639704", appId: "1:191262639704:web:2c51ae1636eda33cfa2c2d"};
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ===== 전역변수 =====
        let selectedDate = '';
        let selectedTime = '';

        // ===== 로그인 =====
        function googleLogin() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).then(() => {
                document.getElementById("calendar-container").style.display = "block";
                document.getElementById("login-button").style.display = "none";
                loadCalendar();
            });
        }

        // ===== 캘린더 로드 =====
        document.getElementById('selected-date').addEventListener('change', loadCalendar);

        function loadCalendar() {
            selectedDate = document.getElementById('selected-date').value;
            if (!selectedDate) return;
            const table = document.getElementById('calendar');
            table.innerHTML = '';

            let h = 5;
            let m = 20;
            let tr = document.createElement('tr'); // 첫 번째 tr 생성

            // 정확한 반복 조건 (11:20까지 포함)
            while (h < 11 || (h === 11 && m <= 20)) {
                let td = document.createElement('td');
                let time = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
                td.innerText = time;
                td.dataset.time = time;
                td.className = 'available';

                td.onclick = () => openPopup(time);
                tr.appendChild(td);

                // 너가 요구한건 6칸
                if (tr.children.length === 6) {
                    table.appendChild(tr);
                    tr = document.createElement('tr');
                }

                m += 8;
                if (m >= 60) { m -= 60; h++; }
            }

            // 남은 tr도 테이블에 추가
            if (tr.children.length > 0) {
                table.appendChild(tr);
            }
        


            // 예약 상태 적용
            db.collection("bookings").where("date", "==", selectedDate).where("status", "==", "승인됨").get().then(snap => {
                snap.forEach(doc => {
                    let time = doc.data().time;
                    let cell = [...document.querySelectorAll(`[data-time='${time}']`)][0];
                    if (cell) {cell.className = 'reserved'; cell.onclick = null;}
                });
            });

            loadUserBookings();
        }

        // ===== 예약 팝업 =====
        function openPopup(time) {
            selectedTime = time;
            document.getElementById('booking-popup').style.display = 'block';
        }

        function closePopup() {
            document.getElementById('booking-popup').style.display = 'none';
        }

        // ===== 예약 신청 =====
        function bookTime() {
            const user = auth.currentUser;
            const name = document.getElementById('reserver-name').value;
            const member = document.getElementById('member-id').value;
            const people = document.getElementById('people').value;
            const remarks = document.getElementById('remarks').value;
            if (!name || !member || !people) {alert('모든 항목 입력'); return;}
            db.collection('bookings').add({
                user: user.email, date: selectedDate, time: selectedTime, people: parseInt(people), memberId: member, reserverName: name, remarks: remarks, status: "대기 중"
            }).then(()=>{alert("예약 완료"); closePopup(); loadCalendar();});
        }

        // ===== 내 예약 확인 =====
        function loadUserBookings() {
            const user = auth.currentUser;
            db.collection('bookings').where("user","==",user.email).get().then(snap=>{
                let res = '<h3>내 예약 내역</h3>';
                snap.forEach(doc=>{
                    const d=doc.data();
                    res += `<p>${d.date} ${d.time} - ${d.reserverName} (${d.people}명) [${d.status}] ${d.remarks}</p>`
                });
                document.getElementById('user-results').innerHTML = res;
            });
        }

        // ===== 관리자 (임시) =====
        function openAdminPanel() {
            const pw = prompt('관리자 비밀번호');
            if(pw==='adm1234') alert('아직 관리자 화면은 미구현입니다');
        }

    </script>
</body>
</html>
